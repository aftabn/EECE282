                 -1   $modde2
0000              1   ;  MODDDE2: Register definition for DE2-8052 softcore
0000              2   ;
0000              3   ;   Copyright (C) 2011  Jesus Calvino-Fraga, jesusc at ece.ubc.ca
0000              4   ;
0000              5   ;   This library is free software; you can redistribute it and/or
0000              6   ;   modify it under the terms of the GNU Lesser General Public
0000              7   ;   License as published by the Free Software Foundation; either
0000              8   ;   version 2.1 of the License, or (at your option) any later version.
0000              9   ;
0000             10   ;   This library is distributed in the hope that it will be useful,
0000             11   ;   but WITHOUT ANY WARRANTY; without even the implied warranty of
0000             12   ;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
0000             13   ;   Lesser General Public License for more details.
0000             14   ;
0000             15   ;   You should have received a copy of the GNU Lesser General Public
0000             16   ;   License along with this library; if not, write to the Free Software
0000             17   ;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
0000             18   ;
0000             19       
0000             20   P0     DATA  080H  ;PORT 0
0000             21   SP     DATA  081H  ;STACK POINTER
0000             22   DPL    DATA  082H  ;DATA POINTER - LOW BYTE
0000             23   DPH    DATA  083H  ;DATA POINTER - HIGH BYTE
0000             24   PCON   DATA  087H  ;POWER CONTROL
0000             25   TCON   DATA  088H  ;TIMER CONTROL
0000             26   TMOD   DATA  089H  ;TIMER MODE
0000             27   TL0    DATA  08AH  ;TIMER 0 - LOW BYTE
0000             28   TL1    DATA  08BH  ;TIMER 1 - LOW BYTE
0000             29   TH0    DATA  08CH  ;TIMER 0 - HIGH BYTE
0000             30   TH1    DATA  08DH  ;TIMER 1 - HIGH BYTE
0000             31   P1     DATA  090H  ;PORT 1
0000             32   SCON   DATA  098H  ;SERIAL PORT CONTROL
0000             33   SBUF   DATA  099H  ;SERIAL PORT BUFFER
0000             34   P2     DATA  0A0H  ;PORT 2
0000             35   IE     DATA  0A8H  ;INTERRUPT ENABLE
0000             36   P3     DATA  0B0H  ;PORT 3
0000             37   IP     DATA  0B8H  ;INTERRUPT PRIORITY
0000             38   T2CON  DATA  0C8H  ;TIMER 2 CONTROL
0000             39   T2MOD  DATA  0C9H  ;TIMER 2 MODE
0000             40   RCAP2L DATA  0CAH  ;TIMER 2 CAPTURE REGISTER - LOW BYTE
0000             41   RCAP2H DATA  0CBH  ;TIMER 2 CAPTURE REGISTER - HIGH BYTE
0000             42   TL2    DATA  0CCH  ;TIMER 2 - LOW BYTE
0000             43   TH2    DATA  0CDH  ;TIMER 2 - HIGH BYTE
0000             44   PSW    DATA  0D0H  ;PROGRAM STATUS WORD
0000             45   ACC    DATA  0E0H  ;ACCUMULATOR
0000             46   B      DATA  0F0H  ;MULTIPLICATION REGISTER
0000             47   IT0    BIT   088H  ;TCON.0 - EXT. INTERRUPT 0 TYPE
0000             48   IE0    BIT   089H  ;TCON.1 - EXT. INTERRUPT 0 EDGE FLAG
0000             49   IT1    BIT   08AH  ;TCON.2 - EXT. INTERRUPT 1 TYPE
0000             50   IE1    BIT   08BH  ;TCON.3 - EXT. INTERRUPT 1 EDGE FLAG
0000             51   TR0    BIT   08CH  ;TCON.4 - TIMER 0 ON/OFF CONTROL
0000             52   TF0    BIT   08DH  ;TCON.5 - TIMER 0 OVERFLOW FLAG
0000             53   TR1    BIT   08EH  ;TCON.6 - TIMER 1 ON/OFF CONTROL
0000             54   TF1    BIT   08FH  ;TCON.7 - TIMER 1 OVERFLOW FLAG
0000             55   RI     BIT   098H  ;SCON.0 - RECEIVE INTERRUPT FLAG
0000             56   TI     BIT   099H  ;SCON.1 - TRANSMIT INTERRUPT FLAG
0000             57   RB8    BIT   09AH  ;SCON.2 - RECEIVE BIT 8
0000             58   TB8    BIT   09BH  ;SCON.3 - TRANSMIT BIT 8
0000             59   REN    BIT   09CH  ;SCON.4 - RECEIVE ENABLE
0000             60   SM2    BIT   09DH  ;SCON.5 - SERIAL MODE CONTROL BIT 2
0000             61   SM1    BIT   09EH  ;SCON.6 - SERIAL MODE CONTROL BIT 1
0000             62   SM0    BIT   09FH  ;SCON.7 - SERIAL MODE CONTROL BIT 0
0000             63   EX0    BIT   0A8H  ;IE.0 - EXTERNAL INTERRUPT 0 ENABLE
0000             64   ET0    BIT   0A9H  ;IE.1 - TIMER 0 INTERRUPT ENABLE
0000             65   EX1    BIT   0AAH  ;IE.2 - EXTERNAL INTERRUPT 1 ENABLE
0000             66   ET1    BIT   0ABH  ;IE.3 - TIMER 1 INTERRUPT ENABLE
0000             67   ES     BIT   0ACH  ;IE.4 - SERIAL PORT INTERRUPT ENABLE
0000             68   ET2    BIT   0ADH  ;IE.5 - TIMER 2 INTERRUPT ENABLE
0000             69   EA     BIT   0AFH  ;IE.7 - GLOBAL INTERRUPT ENABLE
0000             70   RXD    BIT   0B0H  ;P3.0 - SERIAL PORT RECEIVE INPUT
0000             71   TXD    BIT   0B1H  ;P3.1 - SERIAL PORT TRANSMIT OUTPUT
0000             72   INT0   BIT   0B2H  ;P3.2 - EXTERNAL INTERRUPT 0 INPUT
0000             73   INT1   BIT   0B3H  ;P3.3 - EXTERNAL INTERRUPT 1 INPUT
0000             74   T0     BIT   0B4H  ;P3.4 - TIMER 0 COUNT INPUT
0000             75   T1     BIT   0B5H  ;P3.5 - TIMER 1 COUNT INPUT
0000             76   WR     BIT   0B6H  ;P3.6 - WRITE CONTROL FOR EXT. MEMORY
0000             77   RD     BIT   0B7H  ;P3.7 - READ CONTROL FOR EXT. MEMORY
0000             78   PX0    BIT   0B8H  ;IP.0 - EXTERNAL INTERRUPT 0 PRIORITY
0000             79   PT0    BIT   0B9H  ;IP.1 - TIMER 0 PRIORITY
0000             80   PX1    BIT   0BAH  ;IP.2 - EXTERNAL INTERRUPT 1 PRIORITY
0000             81   PT1    BIT   0BBH  ;IP.3 - TIMER 1 PRIORITY
0000             82   PS     BIT   0BCH  ;IP.4 - SERIAL PORT PRIORITY
0000             83   PT2    BIT   0BDH  ;IP.5 - TIMER 2 PRIORITY
0000             84   CAP2   BIT   0C8H  ;T2CON.0 - CAPTURE OR RELOAD SELECT
0000             85   CNT2   BIT   0C9H  ;T2CON.1 - TIMER OR COUNTER SELECT
0000             86   TR2    BIT   0CAH  ;T2CON.2 - TIMER 2 ON/OFF CONTROL
0000             87   EXEN2  BIT   0CBH  ;T2CON.3 - TIMER 2 EXTERNAL ENABLE FLAG
0000             88   TCLK   BIT   0CCH  ;T2CON.4 - TRANSMIT CLOCK SELECT
0000             89   RCLK   BIT   0CDH  ;T2CON.5 - RECEIVE CLOCK SELECTT
0000             90   EXF2   BIT   0CEH  ;T2CON.6 - EXTERNAL TRANSITION FLAG
0000             91   TF2    BIT   0CFH  ;T2CON.7 - TIMER 2 OVERFLOW FLAG
0000             92   P      BIT   0D0H  ;PSW.0 - ACCUMULATOR PARITY FLAG
0000             93   OV     BIT   0D2H  ;PSW.2 - OVERFLOW FLAG
0000             94   RS0    BIT   0D3H  ;PSW.3 - REGISTER BANK SELECT 0
0000             95   RS1    BIT   0D4H  ;PSW.4 - REGISTER BANK SELECT 1
0000             96   F0     BIT   0D5H  ;PSW.5 - FLAG 0
0000             97   AC     BIT   0D6H  ;PSW.6 - AUXILIARY CARRY FLAG
0000             98   CY     BIT   0D7H  ;PSW.7 - CARRY FLAG
0000             99   
0000            100   ; For the altera DE2 configured with an 8051/8052 softcore processor
0000            101   ; we have the following extra registers:
0000            102   
0000            103   HEX0   DATA  091H ; Zero turns the segment on
0000            104   HEX1   DATA  092H ; 
0000            105   HEX2   DATA  093H ; 
0000            106   HEX3   DATA  094H ; 
0000            107   HEX4   DATA  08EH ;
0000            108   HEX5   DATA  08FH ;
0000            109   HEX6   DATA  096H ;
0000            110   HEX7   DATA  097H ;
0000            111   
0000            112   P0MOD  DATA  09AH ; Input/output mode bits for port 0.  '1' sets the port to output mode.
0000            113   P1MOD  DATA  09BH ; Input/output mode bits for port 1
0000            114   P2MOD  DATA  09CH ; Input/output mode bits for port 2
0000            115   P3MOD  DATA  09DH ; Input/output mode bits for port 3
0000            116   
0000            117   LEDRA  DATA  0E8H ; LEDs LEDR0 to LEDR7 (bit addressable, ex: LEDRA.1 for LEDR1)
0000            118   LEDRB  DATA  095H ; LEDs LEDR8 to LEDR15
0000            119   LEDRC  DATA  09EH ; LEDs LEDR16, LEDR15, and LEDG8
0000            120   LEDG   DATA  0F8H ; LEDs LEDG0 to LEDG7 (bit addressable, ex: LEDG.3 for LEDG3)
0000            121   SWA    DATA  0E8H ; Switches SW0 to SW7 (bit addressable, ex: SWA.1 for SW1)
0000            122   SWB    DATA  095H ; Switches SW8 to SW15
0000            123   SWC    DATA  09EH ; Switches SW16 and SW17
0000            124   KEY    DATA  0F8H ; KEY1=KEY.1, KEY2=KEY.2, KEY3=KEY.3.  KEY0 is the reset button! 
0000            125   
0000            126   LCD_CMD   DATA 0D8H ;
0000            127   LCD_DATA  DATA 0D9H ;
0000            128   LCD_MOD   DATA 0DAH ; Write 0xff to make LCD_DATA an output
0000            129   LCD_RW    BIT  0D8H ; '0' writes to LCD
0000            130   LCD_EN    BIT  0D9H ; Toggle from '1' to '0'
0000            131   LCD_RS    BIT  0DAH ; '0' for commands, '1' for data
0000            132   LCD_ON    BIT  0DBH ; Write '1' to power the LCD
0000            133   LCD_BLON  BIT  0DCH ; Write '1' to turn on back light
0000            134   
0000            135   FLASH_CMD  data 0DBH ; The control bits of the flash memory:
0000            136   ; bit 0: FL_RST_N  Set to 1 for normal operation
0000            137   ; bit 1: FL_WE_N
0000            138   ; bit 2: FL_OE_N
0000            139   ; bit 3: FL_CE_N
0000            140   FLASH_DATA data 0DCH ; 8-bit data bus of flash memory.
0000            141   FLASH_MOD  data 0DDH ; 0xff makes FLASH_DATA output.  0x00 makes FLASH_DATA input.
0000            142   FLASH_ADD0 data 0E1H ; address bits 0 to 7.
0000            143   FLASH_ADD1 data 0E2H ; address bits 8 to 15.
0000            144   FLASH_ADD2 data 0E3H ; address bits 16 to 21.
0000            145   
0000              2   
0000              3            CSEG at 0
0000 02082B       4            ljmp MyProgram
0003              5   
0030              6   dseg at 30h
0030              7   x:    ds 2
0032              8   y:    ds 2
0034              9   bcd:  ds 3
0037             10   
0000             11   bseg
0000             12   mf:   dbit 1
0001             13   
0003             14            CSEG
0003             15   
0003             16   myTable:
0003 0190018F    17            DW 400, 399, 397, 396, 395, 393, 392, 390, 389, 388, 386, 385, 384, 382, 381, 380, 378, 377, 375, 374, 373, 371, 370, 369, 367, 366, 364, 363, 362, 360, 359, 358, 356, 355, 354, 352, 351, 349, 348, 347, 345, 344, 343, 341, 340, 339, 337, 336, 334, 333, 332, 330, 329, 328, 326, 325, 324, 322, 321, 319, 318, 317, 315, 314, 313, 311, 310, 309, 307, 306, 304, 303, 302, 300, 299, 298, 296, 295, 293, 292, 291, 289, 288, 287, 285, 284, 283, 281, 280, 278, 277, 276, 274, 273, 272, 270, 269, 268, 266, 265,
     018D018C
     018B0189
     01880186
     01850184
     01820181
     0180017E
     017D017C
     017A0179
     01770176
     01750173
     01720171
     016F016E
     016C016B
     016A0168
     01670166
     01640163
     01620160
     015F015D
     015C015B
     01590158
     01570155
     01540153
     01510150
     014E014D
     014C014A
     01490148
     01460145
     01440142
     0141013F
     013E013D
     013B013A
     01390137
     01360135
     01330132
     0130012F
     012E012C
     012B012A
     01280127
     01250124
     01230121
     0120011F
     011D011C
     011B0119
     01180116
     01150114
     01120111
     0110010E
     010D010C
     010A0109
     01070106
     01050103
     01020101
     00FF00FE
     00FD00FB
     00FA00F8
     00F700F6
     00F400F3
     00F200F0
     00EF00EE
     00EC00EB
     00E900E8
     00E700E5
     00E400E3
     00E100E0
     00DE00DD
     00DC00DA
     00D900D8
     00D600D5
     00D400D2
     00D100CF
     00CE00CD
     00CB00CA
     00C900C7
     00C600C5
     00C300C2
     00C000BF
     00BE00BC
     00BB00BA
     00B800B7
     00B600B4
     00B300B1
     00B000AF
     00AD00AC
     00AB00A9
     00A800A6
     00A500A4
     00A200A1
     00A0009E
     009D009C
     009A0099
     00970096
     00950093
     00920091
     008F008E
     008D008B
     008A0088
     00870086
     00840083
     00820080
     007F007E
     007C007B
     00790078
     00770075
     00740073
     00710070
     006F006D
     006C006A
     00690068
     00660065
     00640062
     0061005F
     005E005D
     005B005A
     00590057
     00560055
     00530052
     0050004F
     004E004C
     004B004A
     00480047
     00460044
     00430041
     0040003F
     003D003C
     003B0039
     00380037
     00350034
     00320031
     0030002E
     002D002C
     002A0029
     00280026
     00250023
     00220021
     001F001E
     001D001B
     001A0018
     00170016
     00140013
     00120010
     000F000E
     000C000B
     00090008
     00070005
     00040003
     00010000
     00010003
     00040006
     00070008
     000A000B
     000C000E
     000F0010
     00120013
     00150016
     00170019
     001A001B
     001D001E
     00200021
     00220024
     00250026
     00280029
     002A002C
     002D002F
     00300031
     00330034
     00350037
     00380039
     003B003C
     003E003F
     00400042
     00430044
     00460047
     0048004A
     004B004D
     004E004F
     00510052
     00530055
     00560057
     0059005A
     005C005D
     005E0060
     00610062
     00640065
     00670068
     0069006B
     006C006D
     006F0070
     00710073
     00740076
     00770078
     007A007B
     007C007E
     007F0080
     00820083
     00850086
     00870089
     008A008B
     008D008E
     008F0091
     00920094
     00950096
     00980099
     009A009C
     009D009F
     00A000A1
     00A300A4
     00A500A7
     00A800A9
     00AB00AC
     00AE00AF
     00B000B2
     00B300B4
     00B600B7
     00B800BA
     00BB00BD
     00BE00BF
     00C100C2
     00C300C5
     00C600C7
     00C900CA
     00CC00CD
     00CE00D0
     00D100D2
     00D400D5
     00D600D8
     00D900DB
     00DC00DD
     00DF00E0
     00E100E3
     00E400E6
     00E700E8
     00EA00EB
     00EC00EE
     00EF00F0
     00F200F3
     00F500F6
     00F700F9
     00FA00FB
     00FD00FE
     00FF0101
     01020104
     01050106
     01080109
     010A010C
     010D010E
     01100111
     01130114
     01150117
     01180119
     011B011C
     011D011F
     01200122
     01230124
     01260127
     0128012A
     012B012D
     012E012F
     01310132
     01330135
     01360137
     0139013A
     013C013D
     013E0140
     01410142
     01440145
     01460148
     0149014B
     014C014D
     014F0150
     01510153
     01540155
     01570158
     015A015B
     015C015E
     015F0160
     01620163
     01650166
     01670169
     016A016B
     016D016E
     016F0171
     01720174
     01750176
     01780179
     017A017C
     017D017E
     01800181
     01830184
     01850187
     01880189
     018B018C
     018D018F
     01900192
     01930194
     01960197
     0198019A
     019B019C
     019E019F
     01A101A2
     01A301A5
     01A601A7
     01A901AA
     01AC01AD
     01AE01B0
     01B101B2
     01B401B5
     01B601B8
     01B901BB
     01BC01BD
     01BF01C0
     01C101C3
     01C401C5
     01C701C8
     01CA01CB
     01CC01CE
     01CF01D0
     01D201D3
     01D401D6
     01D701D9
     01DA01DB
     01DD01DE
     01DF01E1
     01E201E3
     01E501E6
     01E801E9
     01EA01EC
     01ED01EE
     01F001F1
     01F301F4
     01F501F7
     01F801F9
     01FB01FC
     01FD01FF
     02000202
     02030204
     02060207
     0208020A
     020B020C
     020E020F
     02110212
     02130215
     02160217
     0219021A
     021B021D
     021E0220
     02210222
     02240225
     02260228
     0229022B
     022C022D
     022F0230
     02310233
     02340235
     02370238
     023A023B
     023C023E
     023F0240
     02420243
     02440246
     02470249
     024A024B
     024D024E
     024F0251
     02520253
     02550256
     02580259
     025A025C
     025D025E
     02600261
     02620264
     02650267
     02680269
     026B026C
     026D026F
     02700272
     02730274
     02760277
     0278027A
     027B027C
     027E027F
     02810282
     02830285
     02860287
     0289028A
     028B028D
     028E0290
     02910292
     02940295
     02960298
     0299029A
     029C029D
     029F02A0
     02A102A3
     02A402A5
     02A702A8
     02A902AB
     02AC02AE
     02AF02B0
     02B202B3
     02B402B6
     02B702B9
     02BA02BB
     02BD02BE
     02BF02C1
     02C202C3
     02C502C6
     02C802C9
     02CA02CC
     02CD02CE
     02D002D1
     02D202D4
     02D502D7
     02D802D9
     02DB02DC
     02DD02DF
     02E002E1
     02E302E4
     02E602E7
     02E802EA
     02EB02EC
     02EE02EF
     02F102F2
     02F302F5
     02F602F7
     02F902FA
     02FB02FD
     02FE0300
     03010302
     03040305
     03060308
     0309030A
     030C030D
     030F0310
     03110313
     03140315
     03170318
     0319031B
     031C031E
     031F0320
     03220323
     03240326
     03270328
     032A032B
     032D032E
     032F0331
     03320333
     03350336
     03380339
     033A033C
     033D033E
     03400341
     03420344
     03450347
     03480349
     034B034C
     034D034F
     03500351
     03530354
     03560357
     0358035A
     035B035C
     035E035F
     03600362
     03630365
     03660367
     0369036A
     036B036D
     036E0370
     03710372
     03740375
     03760378
     0379037A
     037C037D
     037F0380
     03810383
     03840385
     03870388
     0389038B
     038C038E
     038F0390
     03920393
     03940396
     03970398
     039A039B
     039D039E
     039F03A1
     03A203A3
     03A503A6
     03A703A9
     03AA03AC
     03AD03AE
     03B003B1
     03B203B4
     03B503B7
     03B803B9
     03BB03BC
     03BD03BF
     03C003C1
     03C303C4
     03C603C7
     03C803CA
     03CB03CC
     03CE03CF
     03D003D2
     03D303D5
     03D603D7
     03D903DA
     03DB03DD
     03DE03DF
     03E103E2
     03E403E5
0803             18            
0803             19            
0803             20   myLUT:
0803 C0F9A4B0    21       DB 0C0H, 0F9H, 0A4H, 0B0H, 099H        ; 0 TO 4
     99
0808 9282F880    22       DB 092H, 082H, 0F8H, 080H, 090H  ; 4 TO 9
     90
080D             23      ;DB 088H, 083H, 0C6H, 0A1H, 086H, 08EH  ; A to F
080D             24   
080D             25   ClearDisplay:
080D 759140      26            MOV 91H, #40H
0810 759240      27            MOV 92H, #40H
0813 759340      28            MOV 93H, #40H
0816 759440      29            MOV 94H, #40H
0819 753400      30            mov bcd+0, #00H
081C 753500      31            mov bcd+1, #00H
081F 753600      32            mov bcd+2, #00H
0822 22          33            ret
0823             34   
0823             35   ;GetTempVal:
0823             36   ;        mov x+0, dpl
0823             37   ;        mov x+1, dph
0823             38   ;        ret
0823             39   
0823             40   ReadNumber:
0823 AFE8        41            mov R7, SWA ; Read switches 0 to 7
0825 E595        42            mov a, SWB ; Read switches 8 to 15
0827 5403        43            anl a, #00000011B
0829 FE          44            mov R6, a
082A 22          45            ret
082B             46            
082B             47   ;ADC2Temp:
082B             48   ;        mov dptr, #myTable
082B             49   ;        mov a, R7
082B             50   ;        mov b, #2
082B             51   ;        mul ab
082B             52   ;        add a, dpl
082B             53   ;        mov dpl, a
082B             54   ;        
082B             55   ;        mov R5, b
082B             56   ;        mov a, R6
082B             57   ;        rlc a
082B             58   ;        add a, R5
082B             59   ;        addc a, dph
082B             60   ;        mov dph, a
082B             61   ;        ret
082B             62   
082B             63   MyProgram:
082B 75817F      64            mov SP, #7FH
082E E4          65            clr a
082F F5E8        66            mov LEDRA, a
0831 F595        67            mov LEDRB, a
0833 F59E        68            mov LEDRC, a
0835 F5F8        69            mov LEDG, a
0837 F534        70            mov bcd+0, a
0839 F535        71            mov bcd+1, a
083B F536        72            mov bcd+2, a
083D 1208A7      73            lcall DisplayPos
0840             74   
0840             75   Main:
0840             76            ;lcall ClearDisplay
0840 120823      77            lcall ReadNumber
0843 12084E      78            lcall ADC2Temp
0846             79            ;lcall GetTempVal
0846 12086C      80            lcall hex2BCD
0849 1208E6      81            lcall NegCheck
084C             82            ;lcall Display
084C 80F2        83            sjmp Main
084E             84            
084E             85   ADC2Temp:
084E 900003      86            mov dptr, #mytable
0851 EF          87            mov a, R7 ; R7 has the conversion value
0852 75F002      88            mov b, #2
0855 A4          89            mul ab
0856 2582        90            add a, dpl
0858 F582        91            mov dpl, a
085A             92            
085A EE          93            mov a, R6
085B 33          94            rlc a
085C 25F0        95            add a, b
085E 3583        96            addc a, dph
0860 F583        97            mov dph, a
0862             98            
0862 E4          99            clr a
0863 93         100            movc a, @a+dptr
0864 F531       101            mov x+1, a ; High part from the lookup table
0866 A3         102            inc dptr
0867 E4         103            clr a
0868 93         104            movc a, @a+dptr
0869 F530       105            mov x+0, a ; Low part from the lookup table
086B 22         106            ret
086C            107            
086C            108   ;----------------------------------------------------
086C            109   ; Converts the 16-bit hex number in 'x' to a 
086C            110   ; 5-digit packed BCD in 'bcd' using the
086C            111   ; double-dabble algorithm.
086C            112   ;---------------------------------------------------
086C            113   hex2bcd:
086C C0E0       114            push acc
086E C0D0       115            push psw
0870 C000       116            push AR0
0872            117            
0872 E4         118            clr a
0873 F534       119            mov bcd+0, a ; Initialize BCD to 00-00-00 
0875 F535       120            mov bcd+1, a
0877 F536       121            mov bcd+2, a
0879 7810       122            mov r0, #16  ; Loop counter.
087B            123   
087B            124   hex2bcd_L0:
087B            125            ; Shift binary left     
087B E531       126            mov a, x+1
087D A2E7       127            mov c, acc.7 ; This way x remains unchanged!
087F E530       128            mov a, x+0
0881 33         129            rlc a
0882 F530       130            mov x+0, a
0884 E531       131            mov a, x+1
0886 33         132            rlc a
0887 F531       133            mov x+1, a
0889            134       
0889            135            ; Perform bcd + bcd + carry using BCD arithmetic
0889 E534       136            mov a, bcd+0
088B 3534       137            addc a, bcd+0
088D D4         138            da a
088E F534       139            mov bcd+0, a
0890 E535       140            mov a, bcd+1
0892 3535       141            addc a, bcd+1
0894 D4         142            da a
0895 F535       143            mov bcd+1, a
0897 E536       144            mov a, bcd+2
0899 3536       145            addc a, bcd+2
089B D4         146            da a
089C F536       147            mov bcd+2, a
089E            148   
089E D8DB       149            djnz r0, hex2bcd_L0
08A0            150   
08A0 D000       151            pop AR0
08A2 D0D0       152            pop psw
08A4 D0E0       153            pop acc
08A6 22         154            ret
08A7            155   
08A7            156   DisplayPos:
08A7 900803     157            mov dptr, #myLUT
08AA            158            ; Display Digit 0
08AA E534       159       mov A, bcd+0
08AC 540F       160       anl a, #0fh
08AE 93         161       movc A, @A+dptr
08AF F591       162       mov HEX0, A
08B1            163            ; Display Digit 1
08B1 E534       164       mov A, bcd+0
08B3 C4         165       swap a
08B4 540F       166       anl a, #0fh
08B6 93         167       movc A, @A+dptr
08B7 F592       168       mov HEX1, A
08B9            169            ; Display Digit 2
08B9 E535       170       mov A, bcd+1
08BB 540F       171       anl a, #0fh
08BD 93         172       movc A, @A+dptr
08BE F593       173       mov HEX2, A
08C0            174            ; Display Digit 3
08C0 E535       175       mov A, bcd+1
08C2 C4         176       swap a
08C3 540F       177       anl a, #0fh
08C5 93         178       movc A, @A+dptr
08C6 F594       179       mov HEX3, A
08C8 22         180            ret
08C9            181            
08C9            182   DisplayNeg:
08C9 900803     183            mov dptr, #myLUT
08CC            184            ; Display Digit 0
08CC E534       185       mov A, bcd+0
08CE 540F       186       anl a, #0fh
08D0 93         187       movc A, @A+dptr
08D1 F591       188       mov HEX0, A
08D3            189            ; Display Digit 1
08D3 E534       190       mov A, bcd+0
08D5 C4         191       swap a
08D6 540F       192       anl a, #0fh
08D8 93         193       movc A, @A+dptr
08D9 F592       194       mov HEX1, A
08DB            195            ; Display Digit 2
08DB E535       196       mov A, bcd+1
08DD 540F       197       anl a, #0fh
08DF 93         198       movc A, @A+dptr
08E0 F593       199       mov HEX2, A
08E2            200            ; Display Digit 3
08E2 75943F     201       mov HEX3, #03FH
08E5 22         202       ret
08E6            203            
08E6            204   NegCheck:
08E6 EE         205   mov a, R6
08E7            206   Bit9:
08E7 20E120     207            jb Acc.1, ReturnPos
08EA            208            
08EA            209   Bit8:
08EA 30E019     210            jnb Acc.0, ReturnNeg
08ED            211   
08ED            212   CheckSWA:
08ED EF         213            mov a, R7
08EE 20E719     214            jb Acc.7, ReturnPos
08F1 20E616     215            jb Acc.6, ReturnPos
08F4 30E50F     216            jnb Acc.5, ReturnNeg    
08F7            217            
08F7            218   Bit5Case:
08F7 20E410     219            jb Acc.4, ReturnPos
08FA 20E30D     220            jb Acc.3, ReturnPos
08FD 30E206     221            jnb Acc.2, ReturnNeg
0900            222   
0900            223   Bit3Case:        
0900 20E107     224            jb Acc.1, ReturnPos
0903 20E004     225            jb Acc.0, ReturnPos
0906            226            
0906            227   ReturnNeg:
0906 1208C9     228            lcall DisplayNeg
0909 22         229            ret
090A            230   ReturnPos:
090A 1208A7     231            lcall DisplayPos
090D 22         232            ret
090E            233   en
