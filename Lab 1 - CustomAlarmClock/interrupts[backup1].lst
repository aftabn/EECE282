0000              1   ; clk_v3.asm: Displays seconds, minuts, and hours in HEX2 to HEX7
0000              2   ; We can set the time by flipping SW0 and using KEY.3, KEY.2, KEY.1
0000              3   ; to increment the Hours, Minutes, and Seconds.
0000              4   
                 -1   $MODDE2
0000              1   ;  MODDDE2: Register definition for DE2-8052 softcore
0000              2   ;
0000              3   ;   Copyright (C) 2011  Jesus Calvino-Fraga, jesusc at ece.ubc.ca
0000              4   ;
0000              5   ;   This library is free software; you can redistribute it and/or
0000              6   ;   modify it under the terms of the GNU Lesser General Public
0000              7   ;   License as published by the Free Software Foundation; either
0000              8   ;   version 2.1 of the License, or (at your option) any later version.
0000              9   ;
0000             10   ;   This library is distributed in the hope that it will be useful,
0000             11   ;   but WITHOUT ANY WARRANTY; without even the implied warranty of
0000             12   ;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
0000             13   ;   Lesser General Public License for more details.
0000             14   ;
0000             15   ;   You should have received a copy of the GNU Lesser General Public
0000             16   ;   License along with this library; if not, write to the Free Software
0000             17   ;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
0000             18   ;
0000             19       
0000             20   P0     DATA  080H  ;PORT 0
0000             21   SP     DATA  081H  ;STACK POINTER
0000             22   DPL    DATA  082H  ;DATA POINTER - LOW BYTE
0000             23   DPH    DATA  083H  ;DATA POINTER - HIGH BYTE
0000             24   PCON   DATA  087H  ;POWER CONTROL
0000             25   TCON   DATA  088H  ;TIMER CONTROL
0000             26   TMOD   DATA  089H  ;TIMER MODE
0000             27   TL0    DATA  08AH  ;TIMER 0 - LOW BYTE
0000             28   TL1    DATA  08BH  ;TIMER 1 - LOW BYTE
0000             29   TH0    DATA  08CH  ;TIMER 0 - HIGH BYTE
0000             30   TH1    DATA  08DH  ;TIMER 1 - HIGH BYTE
0000             31   P1     DATA  090H  ;PORT 1
0000             32   SCON   DATA  098H  ;SERIAL PORT CONTROL
0000             33   SBUF   DATA  099H  ;SERIAL PORT BUFFER
0000             34   P2     DATA  0A0H  ;PORT 2
0000             35   IE     DATA  0A8H  ;INTERRUPT ENABLE
0000             36   P3     DATA  0B0H  ;PORT 3
0000             37   IP     DATA  0B8H  ;INTERRUPT PRIORITY
0000             38   T2CON  DATA  0C8H  ;TIMER 2 CONTROL
0000             39   T2MOD  DATA  0C9H  ;TIMER 2 MODE
0000             40   RCAP2L DATA  0CAH  ;TIMER 2 CAPTURE REGISTER - LOW BYTE
0000             41   RCAP2H DATA  0CBH  ;TIMER 2 CAPTURE REGISTER - HIGH BYTE
0000             42   TL2    DATA  0CCH  ;TIMER 2 - LOW BYTE
0000             43   TH2    DATA  0CDH  ;TIMER 2 - HIGH BYTE
0000             44   PSW    DATA  0D0H  ;PROGRAM STATUS WORD
0000             45   ACC    DATA  0E0H  ;ACCUMULATOR
0000             46   B      DATA  0F0H  ;MULTIPLICATION REGISTER
0000             47   IT0    BIT   088H  ;TCON.0 - EXT. INTERRUPT 0 TYPE
0000             48   IE0    BIT   089H  ;TCON.1 - EXT. INTERRUPT 0 EDGE FLAG
0000             49   IT1    BIT   08AH  ;TCON.2 - EXT. INTERRUPT 1 TYPE
0000             50   IE1    BIT   08BH  ;TCON.3 - EXT. INTERRUPT 1 EDGE FLAG
0000             51   TR0    BIT   08CH  ;TCON.4 - TIMER 0 ON/OFF CONTROL
0000             52   TF0    BIT   08DH  ;TCON.5 - TIMER 0 OVERFLOW FLAG
0000             53   TR1    BIT   08EH  ;TCON.6 - TIMER 1 ON/OFF CONTROL
0000             54   TF1    BIT   08FH  ;TCON.7 - TIMER 1 OVERFLOW FLAG
0000             55   RI     BIT   098H  ;SCON.0 - RECEIVE INTERRUPT FLAG
0000             56   TI     BIT   099H  ;SCON.1 - TRANSMIT INTERRUPT FLAG
0000             57   RB8    BIT   09AH  ;SCON.2 - RECEIVE BIT 8
0000             58   TB8    BIT   09BH  ;SCON.3 - TRANSMIT BIT 8
0000             59   REN    BIT   09CH  ;SCON.4 - RECEIVE ENABLE
0000             60   SM2    BIT   09DH  ;SCON.5 - SERIAL MODE CONTROL BIT 2
0000             61   SM1    BIT   09EH  ;SCON.6 - SERIAL MODE CONTROL BIT 1
0000             62   SM0    BIT   09FH  ;SCON.7 - SERIAL MODE CONTROL BIT 0
0000             63   EX0    BIT   0A8H  ;IE.0 - EXTERNAL INTERRUPT 0 ENABLE
0000             64   ET0    BIT   0A9H  ;IE.1 - TIMER 0 INTERRUPT ENABLE
0000             65   EX1    BIT   0AAH  ;IE.2 - EXTERNAL INTERRUPT 1 ENABLE
0000             66   ET1    BIT   0ABH  ;IE.3 - TIMER 1 INTERRUPT ENABLE
0000             67   ES     BIT   0ACH  ;IE.4 - SERIAL PORT INTERRUPT ENABLE
0000             68   ET2    BIT   0ADH  ;IE.5 - TIMER 2 INTERRUPT ENABLE
0000             69   EA     BIT   0AFH  ;IE.7 - GLOBAL INTERRUPT ENABLE
0000             70   RXD    BIT   0B0H  ;P3.0 - SERIAL PORT RECEIVE INPUT
0000             71   TXD    BIT   0B1H  ;P3.1 - SERIAL PORT TRANSMIT OUTPUT
0000             72   INT0   BIT   0B2H  ;P3.2 - EXTERNAL INTERRUPT 0 INPUT
0000             73   INT1   BIT   0B3H  ;P3.3 - EXTERNAL INTERRUPT 1 INPUT
0000             74   T0     BIT   0B4H  ;P3.4 - TIMER 0 COUNT INPUT
0000             75   T1     BIT   0B5H  ;P3.5 - TIMER 1 COUNT INPUT
0000             76   WR     BIT   0B6H  ;P3.6 - WRITE CONTROL FOR EXT. MEMORY
0000             77   RD     BIT   0B7H  ;P3.7 - READ CONTROL FOR EXT. MEMORY
0000             78   PX0    BIT   0B8H  ;IP.0 - EXTERNAL INTERRUPT 0 PRIORITY
0000             79   PT0    BIT   0B9H  ;IP.1 - TIMER 0 PRIORITY
0000             80   PX1    BIT   0BAH  ;IP.2 - EXTERNAL INTERRUPT 1 PRIORITY
0000             81   PT1    BIT   0BBH  ;IP.3 - TIMER 1 PRIORITY
0000             82   PS     BIT   0BCH  ;IP.4 - SERIAL PORT PRIORITY
0000             83   PT2    BIT   0BDH  ;IP.5 - TIMER 2 PRIORITY
0000             84   CAP2   BIT   0C8H  ;T2CON.0 - CAPTURE OR RELOAD SELECT
0000             85   CNT2   BIT   0C9H  ;T2CON.1 - TIMER OR COUNTER SELECT
0000             86   TR2    BIT   0CAH  ;T2CON.2 - TIMER 2 ON/OFF CONTROL
0000             87   EXEN2  BIT   0CBH  ;T2CON.3 - TIMER 2 EXTERNAL ENABLE FLAG
0000             88   TCLK   BIT   0CCH  ;T2CON.4 - TRANSMIT CLOCK SELECT
0000             89   RCLK   BIT   0CDH  ;T2CON.5 - RECEIVE CLOCK SELECTT
0000             90   EXF2   BIT   0CEH  ;T2CON.6 - EXTERNAL TRANSITION FLAG
0000             91   TF2    BIT   0CFH  ;T2CON.7 - TIMER 2 OVERFLOW FLAG
0000             92   P      BIT   0D0H  ;PSW.0 - ACCUMULATOR PARITY FLAG
0000             93   OV     BIT   0D2H  ;PSW.2 - OVERFLOW FLAG
0000             94   RS0    BIT   0D3H  ;PSW.3 - REGISTER BANK SELECT 0
0000             95   RS1    BIT   0D4H  ;PSW.4 - REGISTER BANK SELECT 1
0000             96   F0     BIT   0D5H  ;PSW.5 - FLAG 0
0000             97   AC     BIT   0D6H  ;PSW.6 - AUXILIARY CARRY FLAG
0000             98   CY     BIT   0D7H  ;PSW.7 - CARRY FLAG
0000             99   
0000            100   ; For the altera DE2 configured with an 8051/8052 softcore processor
0000            101   ; we have the following extra registers:
0000            102   
0000            103   HEX0   DATA  091H ; Zero turns the segment on
0000            104   HEX1   DATA  092H ; 
0000            105   HEX2   DATA  093H ; 
0000            106   HEX3   DATA  094H ; 
0000            107   HEX4   DATA  08EH ;
0000            108   HEX5   DATA  08FH ;
0000            109   HEX6   DATA  096H ;
0000            110   HEX7   DATA  097H ;
0000            111   
0000            112   P0MOD  DATA  09AH ; Input/output mode bits for port 0.  '1' sets the port to output mode.
0000            113   P1MOD  DATA  09BH ; Input/output mode bits for port 1
0000            114   P2MOD  DATA  09CH ; Input/output mode bits for port 2
0000            115   P3MOD  DATA  09DH ; Input/output mode bits for port 3
0000            116   
0000            117   LEDRA  DATA  0E8H ; LEDs LEDR0 to LEDR7 (bit addressable, ex: LEDRA.1 for LEDR1)
0000            118   LEDRB  DATA  095H ; LEDs LEDR8 to LEDR15
0000            119   LEDRC  DATA  09EH ; LEDs LEDR16, LEDR15, and LEDG8
0000            120   LEDG   DATA  0F8H ; LEDs LEDG0 to LEDG7 (bit addressable, ex: LEDG.3 for LEDG3)
0000            121   SWA    DATA  0E8H ; Switches SW0 to SW7 (bit addressable, ex: SWA.1 for SW1)
0000            122   SWB    DATA  095H ; Switches SW8 to SW15
0000            123   SWC    DATA  09EH ; Switches SW16 and SW17
0000            124   KEY    DATA  0F8H ; KEY1=KEY.1, KEY2=KEY.2, KEY3=KEY.3.  KEY0 is the reset button! 
0000            125   
0000            126   LCD_CMD   DATA 0D8H ;
0000            127   LCD_DATA  DATA 0D9H ;
0000            128   LCD_MOD   DATA 0DAH ; Write 0xff to make LCD_DATA an output
0000            129   LCD_RW    BIT  0D8H ; '0' writes to LCD
0000            130   LCD_EN    BIT  0D9H ; Toggle from '1' to '0'
0000            131   LCD_RS    BIT  0DAH ; '0' for commands, '1' for data
0000            132   LCD_ON    BIT  0DBH ; Write '1' to power the LCD
0000            133   LCD_BLON  BIT  0DCH ; Write '1' to turn on back light
0000            134   
0000            135   FLASH_CMD  data 0DBH ; The control bits of the flash memory:
0000            136   ; bit 0: FL_RST_N  Set to 1 for normal operation
0000            137   ; bit 1: FL_WE_N
0000            138   ; bit 2: FL_OE_N
0000            139   ; bit 3: FL_CE_N
0000            140   FLASH_DATA data 0DCH ; 8-bit data bus of flash memory.
0000            141   FLASH_MOD  data 0DDH ; 0xff makes FLASH_DATA output.  0x00 makes FLASH_DATA input.
0000            142   FLASH_ADD0 data 0E1H ; address bits 0 to 7.
0000            143   FLASH_ADD1 data 0E2H ; address bits 8 to 15.
0000            144   FLASH_ADD2 data 0E3H ; address bits 16 to 21.
0000            145   
0000              6   
0000              7   org 0000H
0000 0200B3       8            ljmp myprogram
0003              9            
000B             10   org 000BH
000B 020019      11            ljmp ISR_timer0
000E             12            
0000             13   BSEG
0000             14   dayTime:   dbit 1
0001             15   
0030             16   DSEG at 30H
0030             17   count10ms: ds 1
0031             18   seconds:   ds 1
0032             19   minutes:   ds 1
0033             20   hours:     ds 1
0034             21   
000E             22   CSEG
000E             23   
000E             24   ; Look-up table for 7-segment displays
000E             25   myLUT:
000E C0F9A4B0    26       DB 0C0H, 0F9H, 0A4H, 0B0H, 099H
     99
0013 9282F880    27       DB 092H, 082H, 0F8H, 080H, 090H
     90
0018 FF          28       DB 0FFH ; All segments off
0019             29   
0019             30   XTAL           EQU 33333333
0019             31   FREQ           EQU 100
0019             32   TIMER0_RELOAD  EQU 65538-(XTAL/(12*FREQ))
0019             33   
0019             34   ISR_Timer0:
0019             35            ; Reload the timer
0019 758C93      36       mov TH0, #high(TIMER0_RELOAD)
001C 758A81      37       mov TL0, #low(TIMER0_RELOAD)
001F             38       
001F             39       ; Save used register into the stack
001F C0D0        40       push psw
0021 C0E0        41       push acc
0023 C083        42       push dph
0025 C082        43       push dpl
0027             44       
0027 20E836      45       jb SWA.0, ISR_Timer0_L0 ; Setting up time.  Do not increment anything
002A             46       
002A             47       ; Increment the counter and check if a second has passed
002A 0530        48       inc count10ms
002C E530        49       mov a, count10ms
002E B4642F      50       cjne A, #100, ISR_Timer0_L0
0031 753000      51       mov count10ms, #0
0034             52       
0034 E531        53       mov a, seconds
0036 2401        54       add a, #1
0038 D4          55       da a
0039 F531        56       mov seconds, a
003B B46022      57       cjne A, #60H, ISR_Timer0_L0
003E 753100      58       mov seconds, #0
0041             59   
0041 E532        60       mov a, minutes
0043 2401        61       add a, #1
0045 D4          62       da a
0046 F532        63       mov minutes, a
0048 B46015      64       cjne A, #60H, ISR_Timer0_L0
004B 753200      65       mov minutes, #0
004E             66   
004E E533        67       mov a, hours
0050 2401        68       add a, #1
0052 D4          69       da a
0053 F533        70       mov hours, a
0055 B41202      71       cjne A, #12H, NoDayChange
0058 B200        72       cpl dayTime
005A             73   NoDayChange:
005A B41303      74       cjne A, #13H, ISR_Timer0_L0
005D 753301      75       mov hours, #1
0060             76    
0060             77   ISR_Timer0_L0:
0060             78   
0060             79            ; Update the display.  This happens every 10 ms
0060 90000E      80            mov dptr, #myLUT
0063             81            
0063 120116      82            lcall displayDayTime
0066             83            
0066 E531        84            mov a, seconds
0068 540F        85            anl a, #0fH
006A 93          86            movc a, @a+dptr
006B F593        87            mov HEX2, a
006D E531        88            mov a, seconds
006F C4          89            swap a
0070 540F        90            anl a, #0fH
0072 93          91            movc a, @a+dptr
0073 F594        92            mov HEX3, a
0075             93            
0075 E532        94            mov a, minutes
0077 540F        95            anl a, #0fH
0079 93          96            movc a, @a+dptr
007A F58E        97            mov HEX4, a
007C E532        98            mov a, minutes
007E C4          99            swap a
007F 540F       100            anl a, #0fH
0081 93         101            movc a, @a+dptr
0082 F58F       102            mov HEX5, a
0084            103   
0084 E533       104            mov a, hours
0086 540F       105            anl a, #0fH
0088 93         106            movc a, @a+dptr
0089 F596       107            mov HEX6, a
008B E533       108            mov a, hours
008D 20E402     109            jb acc.4, ISR_Timer0_L1
0090 74A0       110            mov a, #0A0H
0092            111   ISR_Timer0_L1:
0092 C4         112            swap a
0093 540F       113            anl a, #0fH
0095 93         114            movc a, @a+dptr
0096 F597       115            mov HEX7, a
0098            116   
0098            117            ; Restore used registers
0098 D082       118            pop dpl
009A D083       119            pop dph
009C D0E0       120            pop acc
009E D0D0       121            pop psw    
00A0 32         122            reti
00A1            123   
00A1            124   Init_Timer0:     
00A1 758901     125            mov TMOD,  #00000001B ; GATE=0, C/T*=0, M1=0, M0=1: 16-bit timer
00A4 C28C       126            clr TR0 ; Disable timer 0
00A6 C28D       127            clr TF0
00A8 758C93     128       mov TH0, #high(TIMER0_RELOAD)
00AB 758A81     129       mov TL0, #low(TIMER0_RELOAD)
00AE D28C       130       setb TR0 ; Enable timer 0
00B0 D2A9       131       setb ET0 ; Enable timer 0 interrupt
00B2 22         132       ret
00B3            133   
00B3            134   myprogram:
00B3 75817F     135            mov SP, #7FH
00B6 75E800     136            mov LEDRA,#0
00B9 759500     137            mov LEDRB,#0
00BC 759E00     138            mov LEDRC,#0
00BF 75F800     139            mov LEDG,#0
00C2            140            
00C2 753159     141            mov seconds, #59H
00C5 753259     142            mov minutes, #59H
00C8 753311     143            mov hours, #11H
00CB C200       144            clr     daytime
00CD            145   
00CD 1200A1     146            lcall Init_Timer0
00D0 D2AF       147       setb EA  ; Enable all interrupts
00D2            148   
00D2            149   M0:
00D2 30E8FD     150            jnb SWA.0, M0
00D5            151   
00D5 20FB15     152            jb KEY.3, M1
00D8 30FBFD     153       jnb KEY.3, $
00DB E533       154       mov a, hours
00DD 2401       155            add a, #1
00DF D4         156            da a
00E0 F533       157            mov hours, a
00E2 B41202     158            cjne A, #12H, NoDayChange2
00E5 B200       159       cpl dayTime
00E7            160   NoDayChange2:
00E7 B41303     161       cjne A, #13H, M1
00EA 753301     162       mov hours, #1
00ED            163   
00ED            164   M1:      
00ED 20FA10     165            jb KEY.2, M2
00F0 30FAFD     166       jnb KEY.2, $
00F3 E532       167       mov a, minutes
00F5 2401       168            add a, #1
00F7 D4         169            da a
00F8 F532       170            mov minutes, a
00FA B46003     171       cjne A, #60H, M2
00FD 753200     172       mov minutes, #0
0100            173   
0100            174   M2:      
0100 20F910     175            jb KEY.1, M3
0103 30F9FD     176            jnb KEY.1, $
0106 E531       177            mov a, seconds
0108 2401       178            add a, #1
010A D4         179            da a
010B F531       180            mov seconds, a
010D B46003     181       cjne A, #60H, M3
0110 753100     182       mov seconds, #0
0113            183   
0113            184   M3:      
0113 0200D2     185            ljmp M0
0116            186            
0116            187   displayDayTime:
0116 200004     188            jb dayTime, day
0119 759108     189            mov HEX0, #08H
011C 22         190            ret
011D            191   day:
011D 75918C     192            mov HEX0, #8CH
0120 22         193            ret
0121            194   END
